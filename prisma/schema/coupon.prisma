enum CouponType {
  AMOUNT // 고정 금액 할인
  RATE // 비율 할인
}

enum CouponScope {
  ORDER // 전체 주문 (주문당 1개)
  CATEGORY // 카테고리 (OrderItem당 1개)
  PRODUCT // 특정 상품 (OrderItem당 1개)
}

enum CouponStatus {
  ISSUED
  USED
  EXPIRED
}

model Coupon {
  id    String      @id @default(uuid())
  name  String
  type  CouponType
  scope CouponScope

  // AMOUNT 쿠폰
  discountAmount Int?

  // RATE 쿠폰
  discountRate      Int?
  maxDiscountAmount Int?

  // 공통 (ORDER scope일 때만 필수)
  minPurchaseAmount Int?

  // 유효기간
  startAt DateTime  @default(now()) // 발급 시작일
  endAt   DateTime? // 발급 종료일

  // 기간제
  validityDays Int? // 사용 가능 일수 (null이면 기간제)

  // 수량 (null = 무제한)
  totalQuantity  Int?
  issuedQuantity Int  @default(0)

  createdAt DateTime @default(now())

  // Relations
  userCoupons UserCoupon[]
  categories  CategoryCoupon[]
  products    ProductCoupon[]
}

model CategoryCoupon {
  couponId   String
  categoryId Int

  // Relations
  coupon   Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([couponId, categoryId])
  @@index([categoryId])
}

model ProductCoupon {
  couponId  String
  productId String

  // Relations
  coupon  Coupon  @relation(fields: [couponId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([couponId, productId])
  @@index([productId])
}

model UserCoupon {
  id       String       @id @default(uuid())
  userId   String
  couponId String
  status   CouponStatus @default(ISSUED)

  createdAt DateTime  @default(now())
  expiredAt DateTime
  usedAt    DateTime?

  // Relations
  user       User        @relation(fields: [userId], references: [id])
  coupon     Coupon      @relation(fields: [couponId], references: [id])
  orders     Order[]
  orderItems OrderItem[]

  @@unique([userId, couponId])
  @@index([userId, status])
  @@index([expiredAt])
}
