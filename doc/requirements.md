```
cmd + shift + v : 미리보기
```

# 요구사항 명세서

## 1. 스테이크홀더 요구사항

### 1.1 관리자

- 상품 및 재고를 효율적으로 관리할 수 있어야 함
- 인기 상품 통계를 통해 재고 입고 계획을 수립할 수 있어야 함
- 쿠폰 발급 및 프로모션을 관리할 수 있어야 함

### 1.2 소매 고객 (B2C)

- 일반 소비자 가격으로 상품을 구매할 수 있어야 함
- 웹과 모바일 앱에서 동일한 장바구니를 확인할 수 있어야 함
- 쿠폰을 발급받아 할인된 가격으로 구매할 수 있어야 함

### 1.3 도매 고객 (B2B)

- 도매 가격으로 대량 구매할 수 있어야 함
- 비즈니스 정보 인증을 통해 도매 자격을 획득할 수 있어야 함
- 프로모션(1+1, 10+10 등)을 적용받을 수 있어야 함

## 2. 기능적 요구사항

### 2.1 상품 관리 시스템

- **FR-001**: 시스템은 상품 정보(이름, 설명, 이미지)를 조회할 수 있어야 함
- **FR-002**: 시스템은 B2B 가격과 B2C 가격을 구분하여 표시해야 함
- **FR-003**: 시스템은 카테고리별로 상품을 분류하여 조회할 수 있어야 함
- **FR-004**: 시스템은 상품의 현재 재고 수량을 실시간으로 표시해야 함

### 2.2 재고 관리 시스템

- **FR-005**: 시스템은 상품별 재고 수량을 실시간으로 확인할 수 있어야 함
- **FR-006**: 시스템은 최근 3일간 결제 완료된 주문 기준으로 인기 상품 Top 5를 집계해야 함
- **FR-007**: 시스템은 재고 수량 변경 이력을 기록해야 함
- **FR-008**: 시스템은 1시간마다 인기 상품 통계를 자동으로 갱신해야 함

### 2.3 장바구니 시스템

- **FR-009**: 시스템은 사용자의 장바구니 정보를 Redis에 저장해야 함
- **FR-010**: 시스템은 웹과 모바일 앱에서 동일한 장바구니 정보를 공유해야 함
- **FR-011**: 시스템은 장바구니에 상품 추가, 수량 변경, 삭제 기능을 제공해야 함
- **FR-012**: 시스템은 30일간 사용하지 않은 장바구니를 자동으로 삭제해야 함

### 2.4 주문 시스템

- **FR-013**: 시스템은 주문 생성 전 모든 상품의 재고를 확인해야 함
- **FR-014**: 시스템은 주문 항목 중 하나라도 재고가 부족하면 전체 주문을 실패 처리해야 함
- **FR-015**: 시스템은 주문서를 생성하고 주문 번호를 발급해야 함
- **FR-016**: 시스템은 주문 상태(결제대기, 결제완료, 처리중, 배송중, 배송완료, 취소, 환불)를 관리해야 함
- **FR-017**: 시스템은 개별 주문 항목의 처리 상태를 관리해야 함

### 2.5 결제 시스템

- **FR-018**: 시스템은 사용자의 포인트 잔액을 기반으로 결제를 처리해야 함
- **FR-019**: 시스템은 쿠폰 할인을 적용하여 최종 결제 금액을 계산해야 함
- **FR-020**: 시스템은 결제 시 포인트 사용 내역을 기록해야 함
- **FR-021**: 시스템은 결제 성공 시 재고가 충분한 상품만 재고를 차감해야 함
- **FR-022**: 시스템은 재고 부족 상품이 있을 경우 해당 order_item만 주문 실패 처리하고, 나머지는 정상 처리해야 함
- **FR-023**: 시스템은 부분 주문 실패 시 실패한 항목을 제외하고 최종 결제 금액을 재계산해야 함

### 2.6 쿠폰 시스템

**쿠폰 타입:**

- **FR-024**: 시스템은 두 가지 쿠폰 타입을 지원해야 함
  - 주문 전체 할인(AMOUNT): 전체 주문 금액에서 고정 금액 할인
  - 상품별 할인(RATE): 특정 상품에 대해 할인율 적용
- **FR-025**: 주문 전체 할인 쿠폰은 최소 구매 금액 조건을 만족해야 사용 가능함
- **FR-026**: 상품별 할인 쿠폰은 해당 상품이 주문에 포함되어야 사용 가능함
- **FR-027**: 시스템은 쿠폰 발급 요청을 작업 큐에 추가해야 함
- **FR-028**: 시스템은 작업 큐를 통해 선착순으로 한정 수량의 쿠폰을 발급해야 함
- **FR-029**: 시스템은 쿠폰의 유효 기간을 검증해야 함
- **FR-030**: 시스템은 최소 구매 금액 조건을 검증해야 함
- **FR-031**: 시스템은 쿠폰 발급 및 사용 이력을 관리해야 함
- **FR-032**: 시스템은 사용된 쿠폰 정보를 영구 보관해야 함

## 3. 비기능적 요구사항

### 3.1 성능

- **NFR-001**: 상품 조회 API는 평균 응답 시간 200ms 이내여야 함
- **NFR-002**: 재고 확인은 실시간으로 처리되어야 함
- **NFR-003**: 장바구니 조회는 평균 응답 시간 100ms 이내여야 함
- **NFR-004**: 쿠폰 발급은 작업 큐를 통해 비동기로 처리되어야 함
- **NFR-005**: 쿠폰 선착순 발급은 작업 큐와 Redis를 통해 동시성을 제어해야 함

### 3.2 가용성

- **NFR-006**: 시스템은 99.9% 이상의 가용성을 유지해야 함
- **NFR-007**: Redis 장애 시에도 기본적인 주문 기능은 동작해야 함

### 3.3 확장성

- **NFR-008**: 시스템은 수평 확장이 가능한 구조여야 함
- **NFR-009**: Redis를 통한 캐싱으로 데이터베이스 부하를 분산해야 함

### 3.4 보안

- **NFR-010**: 사용자 인증 및 권한 관리가 구현되어야 함
- **NFR-011**: 결제 정보는 암호화되어 저장되어야 함

### 3.5 유지보수성

- **NFR-012**: 코드는 NestJS 프레임워크의 모듈 구조를 따라야 함
- **NFR-013**: API 문서가 자동으로 생성되어야 함

## 4. 비즈니스 규칙 및 제약사항

### 4.1 사용자 관리

- **BR-001**: 한 사용자는 하나의 비즈니스 정보만 등록할 수 있음
- **BR-002**: 비즈니스 정보 인증 완료 시에만 B2B 가격이 적용됨
- **BR-003**: 사용자 삭제 시 soft delete 방식으로 처리함

### 4.2 상품 관리

- **BR-004**: 모든 상품은 하나의 카테고리에만 속함
- **BR-005**: 상품 삭제 시 soft delete 방식으로 처리하며, 재고는 유지됨
- **BR-006**: B2B 가격은 B2C 가격보다 낮아야 함

### 4.3 재고 관리

- **BR-007**: 재고는 음수가 될 수 없음
- **BR-008**: 인기 상품 통계는 결제 완료 상태의 주문만 집계함
- **BR-009**: 인기 상품 통계는 1시간마다 자동으로 갱신되며, 최신 통계만 유지함

### 4.4 프로모션

- **BR-010**: 한 상품에 여러 프로모션을 동시에 적용할 수 없음
- **BR-011**: 프로모션은 무료 증정 수량을 포함한 총 수량으로 계산됨
- **BR-012**: 프로모션 적용 시 실제 결제 금액은 유료 수량 기준으로 계산됨

### 4.5 장바구니

- **BR-013**: 비로그인 사용자는 장바구니를 사용할 수 없음
- **BR-014**: 장바구니 데이터는 Redis에 30일간 보관 후 자동 삭제됨
- **BR-015**: 장바구니에 담긴 상품의 가격/재고는 주문 시점에 재검증됨

### 4.6 배송지 관리

- **BR-016**: 한 사용자는 여러 개의 배송지를 등록할 수 있음
- **BR-017**: 사용자당 하나의 기본 배송지만 설정할 수 있음
- **BR-018**: 주문 생성 시 선택된 배송지 정보가 주문에 복사되어 저장됨
- **BR-019**: 배송지 수정/삭제는 과거 주문의 배송지 정보에 영향을 주지 않음

### 4.7 주문 및 결제

**재고 확인 및 품절 처리:**

- BR-020: 주문 생성 시 모든 상품의 재고를 확인함
- BR-021: 재고 부족 상품이 있으면 사용자에게 알림 후 해당 상품 제외 여부를 확인받음
- BR-022: 품절 상품 제외 시 남은 상품 금액으로 주문 금액 및 쿠폰 할인을 재계산함

**쿠폰 할인 계산:**

- **BR-023**: 쿠폰은 주문당 1개, 주문 상품당 1개를 사용할 수 있음
- **BR-024**: 쿠폰 할인은 각 OrderItem의 (기본금액 - 프로모션할인) 비율로 분배됨
  - 분배 금액은 내림 처리하고, 오차는 마지막 OrderItem에 포함함
  - OrderItem별로 couponDiscount 필드에 분배된 할인액을 저장함
- **BR-025**: 품절 상품 제외 후 남은 금액이 쿠폰의 최소 구매 금액 미달 시 해당 쿠폰은 적용되지 않음
  - 사용자에게 쿠폰 미적용 안내 및 주문 계속 여부 확인

**결제 처리:**

- **BR-026**: 결제는 포인트 잔액이 충분한 경우에만 가능함
- **BR-027**: 결제 완료 후 주문된 상품의 재고가 차감됨
- **BR-028**: 결제 시 포인트 사용 내역을 PointHistory에 기록함

**주문 취소 및 환불:**

- **BR-029**: 주문 취소 시 사용된 포인트가 즉시 환불됨
- **BR-030**: 주문이 완전히 취소되고 배송 시작 전(SHIPPED 이전)인 경우에만 쿠폰이 복구됨
  - Order의 모든 OrderItem이 CANCELED 상태
  - AND Order 상태가 SHIPPED 이전
  - 위 조건 만족 시 UserCoupon의 status를 ISSUED로 변경, usedAt을 NULL로 초기화
- **BR-031**: 부분 취소(일부 OrderItem만 CANCELED) 시 쿠폰은 복구되지 않음
- **BR-032**: 부분 취소 시 취소된 OrderItem의 paymentAmount만큼 환불 처리함

### 4.8 쿠폰

**쿠폰 타입:**

- **BR-033**: 고정 금액 할인(AMOUNT) 쿠폰
  - 전체 주문 금액에서 고정 금액(discountAmount) 할인
  - 품절 상품 제외 후에도 할인 금액 유지
  - 단, 제외 후 주문 금액이 할인 금액보다 작으면 쿠폰 미적용
- **BR-034**: 비율 할인(RATE) 쿠폰
  - 특정 상품(applicableProductId)에만 할인율(discountRate) 적용
  - 최대 할인 금액(maxDiscountAmount) 제한 가능
  - 해당 상품이 품절로 제외되면 쿠폰 미적용

**쿠폰 적용 범위:**

- **BR-035**: 전체 상품(ALL) 쿠폰
  - 주문의 모든 상품에 적용
  - OrderItem별 (basePrice - promotionDiscount) 비율로 할인 분배
- **BR-036**: 카테고리(CATEGORY) 쿠폰
  - CouponCategory에 연결된 카테고리의 상품에만 적용
  - 해당 카테고리 상품들의 금액 비율로 할인 분배
- **BR-037**: 특정 상품(PRODUCT) 쿠폰
  - CouponProduct에 연결된 상품에만 적용
  - 해당 상품의 OrderItem에만 할인 적용

**쿠폰 발급:**

- **BR-038**: 쿠폰 발급은 선착순이며, 수량이 소진되면 발급 불가함
- **BR-039**: 한 사용자가 동일한 쿠폰을 중복 발급받을 수 없음
- **BR-040**: 쿠폰 발급 시 Coupon의 유효기간 정책에 따라 UserCoupon의 만료일을 계산하여 저장함
  - 고정 만료일(expiredAt): Coupon.expiredAt 복사
  - 발급 기준(validityDays): 발급일 + validityDays
- **BR-041**: 쿠폰 발급 이력(UserCoupon)은 영구 보관되어 중복 발급을 방지함

**쿠폰 사용 규칙:**

- **BR-042**: 전체 주문(ALL) 쿠폰은 한 주문에 1개만 사용 가능
- **BR-043**: 상품별(CATEGORY/PRODUCT) 쿠폰은 OrderItem당 1개만 사용 가능
- **BR-044**: 전체 주문 쿠폰과 상품별 쿠폰은 함께 사용 가능
- **BR-045**: 만료된 쿠폰은 사용할 수 없음
- **BR-046**: 쿠폰 적용 대상 상품의 합계가 최소 구매 금액을 만족해야 적용됨
- **BR-047**: UserCoupon 1개는 1번만 사용 가능 (중복 사용 불가)
- **BR-048**: 사용된 쿠폰은 주문 취소 시 복구 후 재사용 가능

**쿠폰 할인 계산 순서:**

- **BR-049**: 프로모션 할인 → 상품별 쿠폰 할인 → 전체 주문 쿠폰 할인 순으로 적용
- **BR-050**: 전체 주문 쿠폰은 (상품 금액 - 프로모션 - 상품별 쿠폰) 기준으로 분배
- **BR-051**: 분배 금액은 내림 처리하고 오차는 마지막 OrderItem에 포함

**품절 처리:**

- **BR-052**: 품절 상품 제외 후 주문 금액이 최소 구매 금액 미달 시 쿠폰 미적용
- **BR-053**: CATEGORY/PRODUCT 쿠폰의 대상 상품이 모두 품절로 제외되면 해당 쿠폰 미적용

**쿠폰 복구:**

- **BR-054**: 주문이 완전히 취소되고 배송 시작 전(SHIPPED 이전)인 경우에만 쿠폰이 복구됨
  - Order의 모든 OrderItem이 CANCELED 상태
  - AND Order 상태가 SHIPPED 이전
  - 위 조건 만족 시 UserCoupon의 status를 ISSUED로 변경, usedAt을 NULL로 초기화
- **BR-055**: 부분 취소(일부 OrderItem만 CANCELED)시 해당 상품에 적용한 쿠폰만 복구
- **BR-056**: 복구된 쿠폰은 다시 사용 가능

**쿠폰 데이터 보관:**

- **BR-057**: 쿠폰 발급 이력(UserCoupon)은 영구 보관됨
- **BR-058**: 주문에 사용된 쿠폰 정보(OrderCoupon)는 영구 보관됨

### 4.9 포인트

- **BR-059**: 포인트는 충전과 사용 내역이 모두 기록됨
- **BR-060**: 포인트 사용 시 거래 후 잔액이 함께 기록됨
- **BR-061**: 주문 취소 시 사용된 포인트는 즉시 환불됨

### 4.10 데이터 보관

- **BR-062**: 주문 정보는 영구 보관됨
- **BR-063**: 사용된 쿠폰 정보(user_coupons)는 7일 후 삭제됨
- **BR-064**: 장바구니 정보는 30일간 미사용 시 자동 삭제됨
- **BR-065**: 포인트 이력은 영구 보관됨

## 5. 시스템 제약사항

### 5.1 기술 스택

- **TC-001**: 백엔드는 NestJS 프레임워크를 사용해야 함
- **TC-002**: 데이터베이스는 MySQL 8.0을 사용해야 함
- **TC-003**: ORM은 Prisma를 사용해야 함
- **TC-004**: 작업 큐는 BullMQ와 Redis를 사용해야 함
- **TC-005**: 장바구니는 Redis로 구현해야 함
- **TC-006**: 쿠폰 발급은 BullMQ 작업 큐를 통해 처리되어야 함

### 5.2 인프라

- **TC-007**: Redis는 Docker 컨테이너로 실행되어야 함
- **TC-008**: 작업 큐(인기 상품 통계)는 1시간마다 실행되어야 함
- **TC-009**: 작업 큐(쿠폰 발급)는 요청 순서대로 처리되어야 함
