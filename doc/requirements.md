```
cmd + shift + v : 미리보기
```

# 요구사항 명세서

## 1. 스테이크홀더 요구사항

### 1.1 관리자

- 상품 및 재고를 효율적으로 관리할 수 있어야 함
- 인기 상품 통계를 통해 재고 입고 계획을 수립할 수 있어야 함
- 쿠폰 발급 및 프로모션을 관리할 수 있어야 함

### 1.2 소매 고객 (B2C)

- 일반 소비자 가격으로 상품을 구매할 수 있어야 함
- 웹과 모바일 앱에서 동일한 장바구니를 확인할 수 있어야 함
- 쿠폰을 발급받아 할인된 가격으로 구매할 수 있어야 함

### 1.3 도매 고객 (B2B)

- 도매 가격으로 대량 구매할 수 있어야 함
- 비즈니스 정보 인증을 통해 도매 자격을 획득할 수 있어야 함
- 프로모션(1+1, 10+10 등)을 적용받을 수 있어야 함

## 2. 기능적 요구사항

### 2.1 상품 관리 시스템

- **FR-001**: 시스템은 상품 정보(이름, 설명, 이미지)를 조회할 수 있어야 함
- **FR-002**: 시스템은 B2B 가격과 B2C 가격을 구분하여 표시해야 함
- **FR-003**: 시스템은 카테고리별로 상품을 분류하여 조회할 수 있어야 함
- **FR-004**: 시스템은 상품의 현재 재고 수량을 실시간으로 표시해야 함

### 2.2 재고 관리 시스템

- **FR-005**: 시스템은 상품별 재고 수량을 실시간으로 확인할 수 있어야 함
- **FR-006**: 시스템은 최근 3일간 결제 완료된 주문 기준으로 인기 상품 Top 5를 집계해야 함
- **FR-007**: 시스템은 재고 수량 변경 이력을 기록해야 함
- **FR-008**: 시스템은 1시간마다 인기 상품 통계를 자동으로 갱신해야 함

### 2.3 장바구니 시스템

- **FR-009**: 시스템은 사용자의 장바구니 정보를 Redis에 저장해야 함
- **FR-010**: 시스템은 웹과 모바일 앱에서 동일한 장바구니 정보를 공유해야 함
- **FR-011**: 시스템은 장바구니에 상품 추가, 수량 변경, 삭제 기능을 제공해야 함
- **FR-012**: 시스템은 30일간 사용하지 않은 장바구니를 자동으로 삭제해야 함

### 2.4 주문 시스템

- **FR-013**: 시스템은 주문 생성 전 모든 상품의 재고를 확인해야 함
- **FR-014**: 시스템은 주문 항목 중 하나라도 재고가 부족하면 전체 주문을 실패 처리해야 함
- **FR-015**: 시스템은 주문서를 생성하고 주문 번호를 발급해야 함
- **FR-016**: 시스템은 주문 상태(결제대기, 결제완료, 처리중, 배송중, 배송완료, 취소, 환불)를 관리해야 함
- **FR-017**: 시스템은 개별 주문 항목의 처리 상태를 관리해야 함

### 2.5 결제 시스템

- **FR-018**: 시스템은 사용자의 포인트 잔액을 기반으로 결제를 처리해야 함
- **FR-019**: 시스템은 쿠폰 할인을 적용하여 최종 결제 금액을 계산해야 함
- **FR-020**: 시스템은 결제 시 포인트 사용 내역을 기록해야 함
- **FR-021**: 시스템은 결제 성공 시 재고가 충분한 상품만 재고를 차감해야 함
- **FR-022**: 시스템은 재고 부족 상품이 있을 경우 해당 order_item만 주문 실패 처리하고, 나머지는 정상 처리해야 함
- **FR-023**: 시스템은 부분 주문 실패 시 실패한 항목을 제외하고 최종 결제 금액을 재계산해야 함

### 2.6 쿠폰 시스템

- **FR-024**: 시스템은 쿠폰 발급 요청을 작업 큐에 추가해야 함
- **FR-025**: 시스템은 작업 큐를 통해 선착순으로 한정 수량의 쿠폰을 발급해야 함
- **FR-026**: 시스템은 쿠폰의 유효 기간을 검증해야 함
- **FR-027**: 시스템은 최소 구매 금액 조건을 검증해야 함
- **FR-028**: 시스템은 쿠폰의 최대 할인 금액을 적용해야 함
- **FR-029**: 시스템은 쿠폰 발급 및 사용 이력을 관리해야 함
- **FR-030**: 시스템은 사용된 쿠폰 정보를 7일간 보관 후 삭제해야 함

## 3. 비기능적 요구사항

### 3.1 성능

- **NFR-001**: 상품 조회 API는 평균 응답 시간 200ms 이내여야 함
- **NFR-002**: 재고 확인은 실시간으로 처리되어야 함
- **NFR-003**: 장바구니 조회는 평균 응답 시간 100ms 이내여야 함
- **NFR-004**: 쿠폰 발급은 작업 큐를 통해 비동기로 처리되어야 함
- **NFR-005**: 쿠폰 선착순 발급은 작업 큐와 Redis를 통해 동시성을 제어해야 함

### 3.2 가용성

- **NFR-006**: 시스템은 99.9% 이상의 가용성을 유지해야 함
- **NFR-007**: Redis 장애 시에도 기본적인 주문 기능은 동작해야 함

### 3.3 확장성

- **NFR-008**: 시스템은 수평 확장이 가능한 구조여야 함
- **NFR-009**: Redis를 통한 캐싱으로 데이터베이스 부하를 분산해야 함

### 3.4 보안

- **NFR-010**: 사용자 인증 및 권한 관리가 구현되어야 함
- **NFR-011**: 결제 정보는 암호화되어 저장되어야 함

### 3.5 유지보수성

- **NFR-012**: 코드는 NestJS 프레임워크의 모듈 구조를 따라야 함
- **NFR-013**: API 문서가 자동으로 생성되어야 함

## 4. 비즈니스 규칙 및 제약사항

### 4.1 사용자 관리

- **BR-001**: 한 사용자는 하나의 비즈니스 정보만 등록할 수 있음
- **BR-002**: 비즈니스 정보 인증 완료 시에만 B2B 가격이 적용됨
- **BR-003**: 사용자 삭제 시 soft delete 방식으로 처리함

### 4.2 상품 관리

- **BR-004**: 모든 상품은 하나의 카테고리에만 속함
- **BR-005**: 상품 삭제 시 soft delete 방식으로 처리하며, 재고는 유지됨
- **BR-006**: B2B 가격은 B2C 가격보다 낮아야 함

### 4.3 재고 관리

- **BR-007**: 재고는 음수가 될 수 없음
- **BR-008**: 인기 상품 통계는 결제 완료 상태의 주문만 집계함
- **BR-009**: 인기 상품 통계는 1시간마다 자동으로 갱신되며, 최신 통계만 유지함

### 4.4 프로모션

- **BR-010**: 한 상품에 여러 프로모션을 동시에 적용할 수 없음
- **BR-011**: 프로모션은 무료 증정 수량을 포함한 총 수량으로 계산됨
- **BR-012**: 프로모션 적용 시 실제 결제 금액은 유료 수량 기준으로 계산됨

### 4.5 장바구니

- **BR-013**: 비로그인 사용자는 장바구니를 사용할 수 없음
- **BR-014**: 장바구니 데이터는 Redis에 30일간 보관 후 자동 삭제됨
- **BR-015**: 장바구니에 담긴 상품의 가격/재고는 주문 시점에 재검증됨

### 4.6 주문 및 결제

- **BR-016**: 주문 생성 시 재고를 확인하며, 재고 부족 상품은 해당 order_item만 주문 실패 처리하고 나머지는 정상 진행함
- **BR-017**: 결제는 포인트 잔액이 충분한 경우에만 가능함
- **BR-018**: 쿠폰은 주문당 여러 개를 사용할 수 있음
- **BR-019**: 결제 완료 후 재고가 충분한 상품만 재고가 차감됨
- **BR-020**: 주문 취소 시 사용된 포인트와 쿠폰이 복구됨
- **BR-021**: 부분 주문 실패 시 실패한 항목 금액을 제외하고 결제가 진행됨

### 4.7 쿠폰

- **BR-022**: 쿠폰 발급은 선착순이며, 수량이 소진되면 발급 불가함
- **BR-023**: 만료된 쿠폰은 사용할 수 없음
- **BR-024**: 쿠폰 할인은 최소 구매 금액 조건을 만족해야 적용됨
- **BR-025**: 할인 금액은 최대 할인 금액을 초과할 수 없음
- **BR-026**: 한 사용자가 동일한 쿠폰을 중복 발급받을 수 없음
- **BR-027**: 사용된 쿠폰 정보는 7일 후 자동 삭제되며, 주문 이력에는 영구 보관됨

### 4.8 포인트

- **BR-028**: 포인트는 충전과 사용 내역이 모두 기록됨
- **BR-029**: 포인트 사용 시 거래 후 잔액이 함께 기록됨
- **BR-030**: 주문 취소 시 사용된 포인트는 즉시 환불됨

### 4.9 데이터 보관

- **BR-031**: 주문 정보는 영구 보관됨
- **BR-032**: 사용된 쿠폰 정보(user_coupons)는 7일 후 삭제됨
- **BR-033**: 장바구니 정보는 30일간 미사용 시 자동 삭제됨
- **BR-034**: 포인트 이력은 영구 보관됨

## 5. 시스템 제약사항

### 5.1 기술 스택

- **TC-001**: 백엔드는 NestJS 프레임워크를 사용해야 함
- **TC-002**: 데이터베이스는 MySQL 8.0을 사용해야 함
- **TC-003**: ORM은 Prisma를 사용해야 함
- **TC-004**: 작업 큐는 BullMQ와 Redis를 사용해야 함
- **TC-005**: 장바구니는 Redis로 구현해야 함
- **TC-006**: 쿠폰 발급은 BullMQ 작업 큐를 통해 처리되어야 함

### 5.2 인프라

- **TC-007**: Redis는 Docker 컨테이너로 실행되어야 함
- **TC-008**: 작업 큐(인기 상품 통계)는 1시간마다 실행되어야 함
- **TC-009**: 작업 큐(쿠폰 발급)는 요청 순서대로 처리되어야 함
